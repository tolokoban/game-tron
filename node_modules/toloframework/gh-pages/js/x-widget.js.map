{"version":3,"file":"x-widget.js","sources":["x-widget.js"],"sourcesContent":["/** @module x-widget */require( 'x-widget', function(require, module, exports) { var _=function(){var D={\"en\":{}},X=require(\"$\").intl;function _(){return X(D,arguments);}_.all=D;return _}();\n    /**\n * @example\n * \n * var W = require(\"x-widget\");\n * W({\n *   elem: \"div\",\n *   attr: {\"class\": \"black\"},\n *   prop: {\"$key\": \"menu\"},\n *   children: [\n *     \"This is the \",\n *     W({\n *       elem: \"b\",\n *       children: [\"menu\"]\n *     }),\n *     \"...\"\n *   ]\n * });\n */\n\"use strict\";\n\nvar $ = require(\"dom\");\nvar DB = require(\"tfw.data-binding\");\n\nvar widgets = {};\n// Used for `onWidgetCreation()`.\nvar slots = {};\n\n\nvar Widget = function(id, modName, args, attribs) {\n  try {\n  if (typeof id === 'string') return Widget1.call( this, id, modName, args, attribs );\n    else return Widget2.call( this, id );\n  }\n  catch( ex ) {\n    console.error( ex );\n    throw Error(\"Exception in \" + modName + \"(\" + JSON.stringify(args) + \"):\\n\" + ex);\n  }\n};\n\nfunction Widget1(id, modName, args, attribs ) {\n  if( typeof attribs === 'undefined' ) attribs = {};\n\n  try {\n    var module = require( modName );\n    var wdg = new module( args );\n    var elem;\n    if( typeof wdg.element === 'function' ) elem = wdg.element();\n    else if( wdg.element instanceof Node ) elem = wdg.element;\n    else if( wdg.$ instanceof Node ) elem = wdg.$;\n    else {\n      throw Error(\"Sorry, but \\\"\" + modName + \"\\\" is not a widget nor a view!\", wdg);\n    }\n    var dst = document.getElementById( id );\n    if (dst) {\n      // This widget does exist in the current DOM.\n      // We have to replace it.\n      dst.parentNode.replaceChild( elem, dst );\n    }\n    elem.setAttribute( 'id', id );\n    // Add classes defined in the containing element (`dst`).\n    $.addClass( elem, attribs.class || \"\" );\n    register( id, wdg );\n    return wdg;\n  }\n  catch (ex) {\n    console.error(\"[x-widget] Unable to create widget `\" + modName + \"`!\");\n    console.error(\"[x-widget] id = \", id, \", args = \", args);\n    throw Error(ex);\n  }\n};\n\nfunction Widget2(args) {\n  var id;\n  var elem = $.tag( args.elem );\n  if (args.attr) {\n    // Adding DOM element attributes.\n    $.att( elem, args.attr );\n    id = args.attr.id;\n  }\n\n  if (Array.isArray( args.children )) {\n    // Adding DOM element children.\n    args.children.forEach(function (child) {\n      $.add( elem, child );\n    });\n  }\n  // Converting into a widget.\n  var key, val;\n  var wdg = {};\n\n  if (args.prop) {\n    // Adding READ-ONLY properties to the widget.\n    for( key in args.prop ) {\n      val = args.prop[key];\n      Object.defineProperty( wdg, key, {\n        value: val, writable: false, configurable: false, enumerable: true\n      });\n    }\n  }\n  // Assigning the element to the widget.\n  Object.defineProperty( wdg, 'element', {\n    value: elem, writable: false, configurable: false, enumerable: true\n  });\n\n  if( typeof id !== 'undefined' ) {\n    // Registering the widget only if it as got an id.\n    register( id, wdg );\n  }\n  return wdg;\n}\n\nWidget.template = function( attribs ) {\n  var key, val, id, name = '', args = {};\n  for( key in attribs ) {\n    val = attribs[key];\n    if( key == 'name' ) {\n      name = val;\n    }\n    else if( key == 'id' ) {\n      id = val;\n    }\n    else if( key.charAt(0)=='$' ) {\n      args[key.substr( 1 )] = val;\n    }\n  }\n  var module = require( name );\n  var wdg = new module( args );\n  if( id ) {\n    register( id, wdg );\n  }\n\n  return typeof wdg.element === 'function' ? wdg.element() : (wdg.element || wdg);\n};\n\nfunction register( id, wdg ) {\n  widgets[id] = wdg;\n  var mySlots = slots[id];\n  if( typeof mySlots !== 'undefined' ) {\n    window.setTimeout(function() {\n      mySlots.forEach(function (slot) {\n        slot( wdg );\n      });\n      delete slots[id];\n    });\n  }\n  return typeof wdg.element === 'function' ? wdg.element : (wdg.element || wdg);\n};\n\nWidget.getById = function( id ) {\n  if( !widgets[id] ) throw Error( \"[x-widget.getById()] ID not found: \" + id + \"!\" );\n  return widgets[id];\n};\n\nWidget.onWidgetCreation = function( id, slot ) {\n  if( typeof widgets[id] === 'undefined' ) {\n    if( typeof slots[id] === 'undefined' ) slots[id] = [slot];\n    else slots[id].push( slot );\n  } else {\n    // Asynchronous call to the slot\n    window.setTimeout(\n      function() {\n        slot( widgets[id] );\n      }\n    );\n  }\n};\n\n/**\n * @example\n * var W = require(\"x-widget\");\n * W.bind('wdg.layout-stack0',{\"value\":{\"B\":[[\"btnNewTask\",\"action\"],[\"btnCancel\",\"action\"]]}});\n */\nWidget.bind = function( id, attribs ) {\n  // Destination object: the one on the attributes of which we want to bind.\n  var dstObj = widgets[id];\n  // Destination attribute name.\n  var dstAtt;\n  // Temporary variables to hold source object and attributes.\n  var srcObj, srcAtt;\n  // @example\n  // [\"btnNewTask\",\"action\",\"btnCancel\",\"action\"]\n  var bindings;\n  var slots;\n  // Index used to parse multiple bindings.\n  var idx;\n  for( dstAtt in attribs ) {\n    bindings = attribs[dstAtt].B;\n    if (Array.isArray( bindings )) {\n      // `binding` is an array of arrays.\n      // Subarrays have 2 or 3 elements.\n      // * ID if the source object\n      // * attribute to bind on\n      // * [optional] value  to use as  a constant. This  is the\n      // * case where  we just want  to set a constant  value as\n      // * soon as the source's attribute has changed.\n      bindings.forEach(function (binding) {\n        srcObj = widgets[binding[0]];\n        if( typeof srcObj === 'undefined' ) {\n          console.error( \"[x-widget:bind(\" + id + \")] Trying to bind attribute \\\"\"\n                         + dstAtt\n                         + \"\\\" of widget \\\"\" + id + \"\\\" to the unexisting widget \\\"\"\n                         + binding[0] + \"\\\"!\");\n          return;\n        }\n        srcAtt = binding[1];\n        try {\n          if (binding.length == 2) {\n            DB.bind( srcObj, srcAtt, dstObj, dstAtt );\n          } else {\n            var value = binding[2];\n            DB.bind( srcObj, srcAtt, function() {\n              dstObj[dstAtt] = value;\n            });\n          }\n        } catch( ex ) {\n          console.error(\"Binding error for widget `\" + id + \"`!\", {\n            ex: ex,\n            binding: binding\n          });\n        }\n      });\n    }\n\n    slots = attribs[dstAtt].S;\n    if (Array.isArray( slots )) {\n      // Each item is the name of a function to call when the value of this attribute changes.\n      // If the item is a `string`, the function is from the global `APP` object.\n      // Otherwise, the item must be an array with two children:\n      // the first one  is the module's name and  the second one\n      // id the name of the function.\n      // The slots are called with two arguments:\n      //  * the value and\n      //  * the object the attribute belongs.\n      slots.forEach(function (slot) {\n        var mod = APP;\n        var fct = slot;\n        if (Array.isArray( slot )) {\n          try {\n            mod = require(slot[0]);\n          } catch( ex ) {\n            console.error(\"[x-widget:bind] Widget `\" + id + \"` can't require unexistent `\"\n                          + slot[0] + \"`: \", ex);\n            throw( ex );\n          }\n          fct = slot[1];\n        }\n        fct = mod[fct];\n        if (typeof fct !== 'function') {\n          if( Array.isArray(slot) ) {\n            throw Error(\"[x-widget:bind]  Widget `\" + id + \"` use unexisting slot `\"\n                        + slot[1] + \"` of module `\" + slot[0] + \"`!\");\n          } else {\n            throw Error(\"[x-widget:bind]  Widget `\" + id + \"` use unexisting slot `\"\n                        + slot + \"` of main module `APP`!\");\n          }\n        } else {\n          try {\n            DB.bind( dstObj, dstAtt, fct );\n          } catch( ex ) {\n            console.error(\"Binding error for widget `\" + id + \"`!\", {\n              ex: ex,\n              dstObj: dstObj,\n              dstAtt: dstAtt,\n              fct: fct,\n              slot: slot\n            });\n          }\n        }\n      });\n\n    }\n  }\n};\n\nmodule.exports = Widget;\n\n\n  \nmodule.exports._ = _;\n});"],"names":["require","module","exports","Widget1","id","modName","args","attribs","elem","wdg","element","Node","$","Error","dst","document","getElementById","parentNode","replaceChild","setAttribute","addClass","class","register","ex","console","error","Widget2","tag","attr","att","Array","isArray","children","forEach","child","add","key","val","prop","Object","defineProperty","value","writable","configurable","enumerable","widgets","mySlots","slots","window","setTimeout","slot","_","X","D","arguments","en","intl","all","DB","Widget","call","this","JSON","stringify","template","name","charAt","substr","getById","onWidgetCreation","push","bind","dstAtt","srcObj","srcAtt","bindings","dstObj","B","binding","length","S","mod","APP","fct"],"mappings":"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"}