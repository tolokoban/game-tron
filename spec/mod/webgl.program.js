"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}require("webgl.program",function(require,module){function createAttributes(gl,shaderProgram){for(var item,attribs={},attribsCount=gl.getProgramParameter(shaderProgram,gl.ACTIVE_ATTRIBUTES),index=0;index<attribsCount;index++)item=gl.getActiveAttrib(shaderProgram,index),item.typeName=this.getTypeName(item.type),item.length=getSize(gl,item),item.location=gl.getAttribLocation(shaderProgram,item.name),attribs[item.name]=item;this.attribs=attribs,Object.freeze(this.attribs)}function createUniforms(gl,shaderProgram){for(var item,uniforms={},uniformsCount=gl.getProgramParameter(shaderProgram,gl.ACTIVE_UNIFORMS),index=0;index<uniformsCount;index++)item=gl.getActiveUniform(shaderProgram,index),uniforms[item.name]=gl.getUniformLocation(shaderProgram,item.name),Object.defineProperty(this,"$".concat(item.name),{set:createUniformSetter.call(this,gl,item,uniforms[item.name],this._typesNamesLookup),get:createUniformGetter.call(this,item),enumerable:!0,configurable:!1});this.uniforms=uniforms,Object.freeze(this.uniforms)}function parseIncludes(codes,includes){for(var result={},_arr=Object.keys(codes),_i2=0;_i2<_arr.length;_i2++){var id=_arr[_i2],code=codes[id];result[id]=code.split("\n").map(function(line){if("#include"!==line.trim().substr(0,8))return line;var pos=line.indexOf("#include")+8,includeName=line.substr(pos).trim();"'<\"".indexOf(includeName.charAt(0))>-1&&(includeName=includeName.substr(1,includeName.length-2));var snippet=includes[includeName];if("string"!=typeof snippet)throw console.error("Include <".concat(includeName,"> not found in "),includes),Error("Include not found in shader: ".concat(includeName));return snippet}).join("\n")}return result}function createUniformSetterInteger(gl,item,nameGL,nameJS){var that=this;return 1===item.size?function(v){gl.uniform1i(nameGL,v),that[nameJS]=v}:function(v){gl.uniform1iv(nameGL,v),that[nameJS]=v}}function createUniformSetterFloat(gl,item,nameGL,nameJS){var that=this;return 1===item.size?function(v){gl.uniform1f(nameGL,v),that[nameJS]=v}:function(v){gl.uniform1fv(nameGL,v),that[nameJS]=v}}function createUniformSetterFloatVec2(gl,item,nameGL,nameJS){var that=this;if(1===item.size)return function(v){gl.uniform2fv(nameGL,v),that[nameJS]=v};throw Error("[webgl.program.createWriter] Don't know how to deal arrays of FLOAT_VEC2 in uniform `".concat(item.name,"'!'"))}function createUniformSetterFloatVec3(gl,item,nameGL,nameJS){var that=this;if(1===item.size)return function(v){gl.uniform3fv(nameGL,v),that[nameJS]=v};throw Error("[webgl.program.createWriter] Don't know how to deal arrays of FLOAT_VEC3 in uniform `".concat(item.name,"'!'"))}function createUniformSetterFloatVec4(gl,item,nameGL,nameJS){var that=this;if(1===item.size)return function(v){gl.uniform4fv(nameGL,v),that[nameJS]=v};throw Error("[webgl.program.createWriter] Don't know how to deal arrays of FLOAT_VEC4 in uniform `".concat(item.name,"'!'"))}function createUniformSetterFloatMat2(gl,item,nameGL,nameJS){var that=this;if(1===item.size)return function(v){gl.uniformMatrix2fv(nameGL,!1,v),that[nameJS]=v};throw Error("[webgl.program.createWriter] Don't know how to deal arrays of FLOAT_MAT2 in uniform `".concat(item.name,"'!'"))}function createUniformSetterFloatMat3(gl,item,nameGL,nameJS){var that=this;if(1===item.size)return function(v){gl.uniformMatrix3fv(nameGL,!1,v),that[nameJS]=v};throw Error("[webgl.program.createWriter] Don't know how to deal arrays of FLOAT_MAT3 in uniform `".concat(item.name,"'!'"))}function createUniformSetterFloatMat4(gl,item,nameGL,nameJS){var that=this;if(1===item.size)return function(v){gl.uniformMatrix4fv(nameGL,!1,v),that[nameJS]=v};throw Error("[webgl.program.createWriter] Don't know how to deal arrays of FLOAT_MAT4 in uniform `".concat(item.name,"'!'"))}function createUniformSetter(gl,item,nameGL,lookup){var nameJS="_$".concat(item.name);switch(item.type){case gl.BYTE:case gl.UNSIGNED_BYTE:case gl.SHORT:case gl.UNSIGNED_SHORT:case gl.INT:case gl.UNSIGNED_INT:case gl.SAMPLER_2D:return createUniformSetterInteger.call(this,gl,item,nameGL,nameJS);case gl.FLOAT:return createUniformSetterFloat.call(this,gl,item,nameGL,nameJS);case gl.FLOAT_VEC2:return createUniformSetterFloatVec2.call(this,gl,item,nameGL,nameJS);case gl.FLOAT_VEC3:return createUniformSetterFloatVec3.call(this,gl,item,nameGL,nameJS);case gl.FLOAT_VEC4:return createUniformSetterFloatVec4.call(this,gl,item,nameGL,nameJS);case gl.FLOAT_MAT2:return createUniformSetterFloatMat2.call(this,gl,item,nameGL,nameJS);case gl.FLOAT_MAT3:return createUniformSetterFloatMat3.call(this,gl,item,nameGL,nameJS);case gl.FLOAT_MAT4:return createUniformSetterFloatMat4.call(this,gl,item,nameGL,nameJS);default:throw Error("[webgl.program.createUniformSetter] Don't know how to deal with uniform `".concat(item.name,"` of type ").concat(lookup[item.type],"!"));}}function createUniformGetter(item){var that=this,name="_$".concat(item.name);return function(){return that[name]}}function getShader(type,gl,code){var shader=gl.createShader(type);return gl.shaderSource(shader,code),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS)?shader:(console.error("An error occurred compiling the shader: ".concat(gl.getShaderInfoLog(shader))),console.warn(code),null)}function getFragmentShader(gl,code){return getShader(gl.FRAGMENT_SHADER,gl,code)}function getVertexShader(gl,code){return getShader(gl.VERTEX_SHADER,gl,code)}function getTypesNamesLookup(gl){for(var lookup={},_arr2=Object.keys(gl),_i3=0;_i3<_arr2.length;_i3++){var k=_arr2[_i3],v=gl[k];"number"==typeof v&&(lookup[v]=k)}return lookup}function getTypeName(gl,type){return getTypesNamesLookup(gl)[type]}function getSize(gl,item){switch(item.type){case gl.FLOAT_VEC4:return 4;case gl.FLOAT_VEC3:return 3;case gl.FLOAT_VEC2:return 2;case gl.FLOAT:return 1;default:throw Error("[webgl.program:getSize] I don't know the size of the attribute '".concat(item.name,"' because I don't know the type ").concat(getTypeName(item.type),"!"));}}function _readonly(target,name,value){return"string"==typeof name?void("function"==typeof value?Object.defineProperty(target,name,{get:value,set:function set(){throw Error("The attribute \"".concat(name,"\" is read onyl!"))},configurable:!1,enumerable:!0}):Object.defineProperty(target,name,{value:value,writable:!1,configurable:!1,enumerable:!0})):void Object.keys(name).forEach(function(key){_readonly(target,key,name[key])})}var _=function(){function _(){return X(D,arguments)}var D={en:{},fr:{}},X=require("$").intl;return _.all=D,_}();var BPE=new Float32Array().BYTES_PER_ELEMENT,Program=function(){function Program(gl,_codes,includes){if(_classCallCheck(this,Program),"string"!=typeof _codes.vert)throw Error("[webgl.program] Missing attribute `vert` in argument `codes`!");if("string"!=typeof _codes.frag)throw Error("[webgl.program] Missing attribute `frag` in argument `codes`!");var codes=parseIncludes(_codes,includes);this.gl=gl,Object.freeze(this.gl),this.BPE=BPE,Object.freeze(this.BPE),this._typesNamesLookup=getTypesNamesLookup(gl);var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,getVertexShader(gl,codes.vert)),gl.attachShader(shaderProgram,getFragmentShader(gl,codes.frag)),gl.linkProgram(shaderProgram),this.program=shaderProgram,Object.freeze(this.program),this.use=function(){gl.useProgram(shaderProgram)},this.use(),createAttributes.call(this,gl,shaderProgram),createUniforms.call(this,gl,shaderProgram)}return _createClass(Program,[{key:"getTypeName",value:function(typeId){return this._typesNamesLookup[typeId]}},{key:"bindAttribs",value:function bindAttribs(buffer){var gl=this.gl;gl.bindBuffer(gl.ARRAY_BUFFER,buffer);for(var totalSize=0,_len=arguments.length,names=Array(1<_len?_len-1:0),_key=1;_key<_len;_key++)names[_key-1]=arguments[_key];for(var _i=0;_i<names.length;_i++){var name=names[_i],attrib=this.attribs[name];if(!attrib)throw Error("Cannot find attribute \"".concat(name,"\"!\n")+"It may be not active because unused in the shader.\n"+"Available attributes are: ".concat(Object.keys(this.attribs).map(JSON.stringify).join(", ")));totalSize+=attrib.size*attrib.length*BPE}var offset=0;names.forEach(function(name){var attrib=this.attribs[name];gl.enableVertexAttribArray(attrib.location),gl.vertexAttribPointer(attrib.location,attrib.size*attrib.length,gl.FLOAT,!1,totalSize,offset),offset+=attrib.size*attrib.length*BPE},this)}},{key:"readonly",value:function readonly(target,name,value){return _readonly(taget,name,value)}}]),Program}();module.exports=Program,module.exports._=_});